<script>
const el = {};
let binaryB64 = "";
let decoded = "";
let view = "binary";
let statusTimer = null;

window.addEventListener("DOMContentLoaded", () => {
    el.statusBar = document.getElementById("statusBar");
    el.statusText = document.getElementById("statusText");
    el.spinner = document.getElementById("spinner");

    el.preview = document.getElementById("preview");
    el.matchResult = document.getElementById("matchResult");
    el.toggleView = document.getElementById("toggleView");
    el.saveBtn = document.getElementById("saveBtn");
    el.saveName = document.getElementById("saveName");
    el.writeSelect = document.getElementById("writeSelect");
    el.portSelect = document.getElementById("portSelect");
    el.diff = document.getElementById("diff");
    el.version = document.getElementById("version");
    el.usbArea = document.getElementById("usbArea");

    loadVersion();
});

/* ===== STATUS BAR ===== */
function setStatus(msg, cls) {
    clearTimeout(statusTimer);

    el.statusText.textContent = msg;
    el.statusBar.className = cls;
    el.spinner.style.display = (cls === "working") ? "block" : "none";

    if (cls === "success") {
        statusTimer = setTimeout(() => {
            el.statusText.textContent = "Idle";
            el.statusBar.className = "idle";
        }, 3000);
    }
}

/* ===== CORE ===== */
function loadVersion() {
    fetch("/version").then(r => r.json()).then(d => el.version.textContent = d.version);
}

function readEdid() {
    setStatus("Reading EDID…", "working");
    fetch(`/read_and_compare_edid?port=${el.portSelect.value}`)
        .then(r => r.json())
        .then(d => {
            binaryB64 = d.binary_b64;
            decoded = d.decoded;
            el.matchResult.textContent = d.match;
            el.toggleView.disabled = false;
            el.saveBtn.disabled = d.match !== "UNKNOWN";
            el.saveName.disabled = d.match !== "UNKNOWN";
            setBinaryView();
            setStatus("Read complete ✔", "success");
        });
}

function toggleView() {
    view === "binary" ? setDecodedView() : setBinaryView();
}

function setBinaryView() {
    view = "binary";
    el.toggleView.textContent = "View: Binary";
    const bin = atob(binaryB64);
    let out = "";
    for (let i = 0; i < bin.length; i++) {
        out += bin.charCodeAt(i).toString(16).padStart(2, "0") + " ";
        if ((i + 1) % 16 === 0) out += "\n";
    }
    el.preview.value = out;
}

function setDecodedView() {
    view = "decoded";
    el.toggleView.textContent = "View: Decoded";
    el.preview.value = decoded;
}

function saveEdid() {
    fetch("/save_edid", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            filename: el.saveName.value,
            binary: binaryB64
        })
    }).then(() => setStatus("Saved ✔", "success"));
}

function confirmWrite() {
    const f = el.writeSelect.value;
    if (!f) return alert("Select EDID");
    if (!confirm(`Write '${f}' to port ${el.portSelect.value}?`)) return;
    writeEdid();
}

function writeEdid() {
    setStatus("Writing EDID…", "working");
    fetch("/write_edid", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            filename: el.writeSelect.value,
            port: el.portSelect.value
        })
    })
    .then(r => r.json())
    .then(d => {
        if (d.verified) {
            setStatus("Write + Verify ✔", "success");
        } else {
            setStatus("Verify FAILED", "warning");
            el.diff.textContent = d.diff || "";
        }
    });
}

function resetEdid() {
    el.preview.value = "";
    el.matchResult.textContent = "—";
    el.toggleView.disabled = true;
    el.saveBtn.disabled = true;
    el.saveName.disabled = true;
    el.diff.textContent = "";
    setStatus("Idle", "idle");
}

/* ===== USB ===== */
function loadUsb() {
    el.usbArea.innerHTML = "";
    fetch("/usb/status")
        .then(r => r.json())
        .then(drives => {
            drives.forEach(d => {
                const div = document.createElement("div");
                div.innerHTML = `
                    <h3>${d.name}</h3>
                    <button onclick="importUsb('${d.path}')">Import</button>
                    ${d.read_only ? "" : `<button onclick="exportUsb('${d.path}')">Export</button>`}
                `;
                el.usbArea.appendChild(div);
            });
        });
}

function importUsb(mount) {
    fetch(`/usb/scan?mount=${mount}`)
        .then(r => r.json())
        .then(files => {
            const names = files.filter(f => !f.exists).map(f => f.name);
            fetch("/usb/import", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ mount, files: names })
            }).then(() => setStatus("Import complete ✔", "success"));
        });
}

function exportUsb(mount) {
    const files = Array.from(el.writeSelect.options).map(o => o.value).filter(Boolean);
    fetch("/usb/export", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ mount, files })
    }).then(() => setStatus("Export complete ✔", "success"));
}

function confirmShutdown() {
    if (!confirm("Shutdown system?")) return;
    fetch("/shutdown", { method: "POST" });
}

function confirmReboot() {
    if (!confirm("Reboot system?")) return;
    fetch("/reboot", { method: "POST" });
}
</script>
