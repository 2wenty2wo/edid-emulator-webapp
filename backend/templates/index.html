<!DOCTYPE html>
<html>
<head>
    <title>EDID Emulator</title>
    <style>
        body { font-family: Arial; max-width: 900px; margin: auto; }
        textarea { width: 100%; height: 260px; margin-top: 10px; }
        button { margin: 5px 5px 5px 0; }
        select, input { margin: 5px 0; }

        .status { padding: 8px; font-weight: bold; border-radius: 4px; }
        .idle { background: #eee; }
        .working { background: #ffeaa7; }
        .success { background: #55efc4; }
        .warning { background: #fab1a0; }
        .error { background: #ff7675; }
    </style>
</head>
<body>

<div style="display:flex; justify-content:space-between; align-items:center;">
    <div>Version: <b id="version">loading…</b></div>
    <button onclick="updateRepo()">Update</button>
</div>

<hr>

<h2>EDID Emulator</h2>

<div style="margin-bottom:10px;">
    <button onclick="readEdid()">Read EDID</button>
    <button onclick="resetEdid()">Reset</button>
    <button id="toggleView" onclick="toggleView()" disabled>
        View: Binary
    </button>
</div>

<p>Match: <b id="matchResult">—</b></p>

<h3>EDID Preview</h3>
<textarea id="preview" readonly></textarea>

<h3>Save New EDID</h3>
<input id="saveName" placeholder="filename.bin" disabled>
<button id="saveBtn" onclick="saveEdid()" disabled>Save</button>

<h3>Write EDID</h3>
<select id="writeSelect">
    <option value="">-- select --</option>
    {% for f in files %}
        <option value="{{ f }}">{{ f }}</option>
    {% endfor %}
</select>
<button onclick="writeEdid()">Write</button>

<div id="status" class="status idle">Idle</div>

<script>
let binaryB64 = "";
let decoded = "";
let view = "binary";

function setStatus(msg, cls) {
    const s = document.getElementById("status");
    s.textContent = msg;
    s.className = "status " + cls;
}

function loadVersion() {
    fetch("/version")
        .then(r => r.json())
        .then(d => {
            document.getElementById("version").textContent = d.version;
        });
}

function updateRepo() {
    if (!confirm("Update application from GitHub?")) return;
    setStatus("Updating repository...", "working");

    fetch("/update_repo", { method: "POST" })
        .then(r => r.json())
        .then(d => {
            if (d.error) {
                setStatus("Update failed", "error");
            } else {
                setStatus("Update complete ✔ Restarting recommended", "success");
                loadVersion();
            }
        });
}

function readEdid() {
    setStatus("Reading EDID...", "working");

    fetch("/read_and_compare_edid")
        .then(r => r.json())
        .then(d => {
            if (d.error) {
                setStatus(d.error, "error");
                return;
            }

            binaryB64 = d.binary_b64;
            decoded = d.decoded;

            document.getElementById("matchResult").textContent = d.match;
            document.getElementById("toggleView").disabled = false;

            if (d.match === "UNKNOWN") {
                saveBtn.disabled = false;
                saveName.disabled = false;
            } else {
                saveBtn.disabled = true;
                saveName.disabled = true;
            }

            setBinaryView();
            setStatus("Read complete ✔", "success");
        });
}

function toggleView() {
    view === "binary" ? setDecodedView() : setBinaryView();
}

function setBinaryView() {
    view = "binary";
    toggleViewBtn().textContent = "View: Binary";

    const bin = atob(binaryB64);
    let out = "";
    for (let i = 0; i < bin.length; i++) {
        out += bin.charCodeAt(i).toString(16).padStart(2, "0") + " ";
        if ((i + 1) % 16 === 0) out += "\n";
    }
    preview.value = out;
}

function setDecodedView() {
    view = "decoded";
    toggleViewBtn().textContent = "View: Decoded";
    preview.value = decoded;
}

function saveEdid() {
    const name = saveName.value.trim();
    if (!name) return alert("Enter filename");

    fetch("/save_edid", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: name, binary: binaryB64 })
    })
    .then(r => r.json())
    .then(d => {
        if (d.error) setStatus(d.error, "error");
        else setStatus("Saved successfully ✔", "success");
    });
}

function writeEdid() {
    const f = writeSelect.value;
    if (!f) return alert("Select file");

    setStatus("Writing EDID...", "working");

    fetch("/write_edid", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: f })
    })
    .then(r => r.json())
    .then(d => {
        if (d.error) {
            setStatus("Write failed: " + d.error, "error");
        } else if (d.verified) {
            setStatus("Write complete ✔ Verified ✔", "success");
        } else {
            setStatus("Write complete ⚠ Verification FAILED", "warning");
        }
    });
}

function resetEdid() {
    binaryB64 = "";
    decoded = "";
    view = "binary";
    preview.value = "";
    matchResult.textContent = "—";
    toggleViewBtn().disabled = true;
    saveBtn.disabled = true;
    saveName.disabled = true;
    saveName.value = "";
    setStatus("Idle", "idle");
}

function toggleViewBtn() {
    return document.getElementById("toggleView");
}

loadVersion();
</script>

</body>
</html>
